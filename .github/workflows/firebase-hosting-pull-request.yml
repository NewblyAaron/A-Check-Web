name: Deploy to Firebase Hosting as preview on pull request
on:
  pull_request:
    paths:
      - "lib/**"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
        - name: Checkout repo
          uses: actions/checkout@v4
        - name: Setup Java
          uses: actions/setup-java@v4
          with: 
            distribution: 'temurin'
            java-version: '17'
        - name: Setup Flutter
          uses: subosito/flutter-action@master
        - name: Install dependencies
          run: flutter pub get --no-example
        - name: Build build_runner outputs
          run: dart run build_runner build --delete-conflicting-outputs
        - name: Build web app
          run: flutter build web --no-source-maps --web-renderer=canvaskit
        - name: Archive production artifact
          uses: actions/upload-artifact@master
          with:
            name: webapp
            path: build/web/

  deploy:
    name: Deploy to Firebase
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: webapp
          path: build/web/
      - name: Deploy to Firebase
        uses: w9jds/firebase-action@v13.0.1
        with:
          args: hosting:channel:deploy --expires 3d
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}